---
// 1. Unified Node Detection (Server-Side)
const url = Astro.url;
const params = url.searchParams;
const source = params.get('utm_source')?.toLowerCase() || "";
const domain = url.hostname.toLowerCase();

// Identify Node Type
const isScience = domain.includes('southafricanbotanical') || source.includes('science') || source.includes('org.za');
const isIK = domain.includes('indigenousknowledge') || source.includes('ik') || source.includes('mesembrine');

let identity = {
  title: "SABM",
  suffix: "Compliance Gateway",
  label: "TRADE & EXPORT NODE",
  color: "#4ade80", 
  accent: "rgba(34, 197, 94, 0.1)",
  description: "This gateway facilitates BABS & NEMBA compliance for the South African botanical supply chain. We provide the digital 'Toll-Booth' infrastructure for frictionless trade."
};

if (isIK) {
  identity = {
    title: "IK",
    suffix: "Protection Shield",
    label: "HERITAGE & IK PROTECTION NODE",
    color: "#f87171", 
    accent: "rgba(248, 113, 113, 0.1)",
    description: "The primary notary for Indigenous Knowledge (IK) protection. This node secures the automated royalty splitter for traditional holders."
  };
} else if (isScience) {
  identity = {
    title: "SABM",
    suffix: "Science & Innovation",
    label: "SCIENCE & PHYTOTECH NODE",
    color: "#38bdf8", 
    accent: "rgba(56, 189, 248, 0.1)",
    description: "Scientific archive for botanical assets, DNA barcoding, and phytochemical integrity verification."
  };
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>{identity.title} {identity.suffix} | Official Notary</title>
	</head>
	<body style="margin: 0; font-family: system-ui, sans-serif; background: #0f172a; color: white; line-height: 1.5;">
		
    <div id="node-bar" style={`background: ${identity.color}; color: #000; padding: 12px; text-align: center; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; font-size: 0.8rem;`}>
      INSTITUTIONAL LAYER: {identity.label}
    </div>

    <main style="max-width: 800px; margin: auto; padding: 4rem 2rem; min-height: 100vh;">
			<header style="text-align: center; margin-bottom: 4rem; border-bottom: 1px solid #334155; padding-bottom: 2rem;">
				<h1 id="main-title" style={`font-size: 3.5rem; font-weight: 800; margin: 0; color: ${identity.color};`}>
					{identity.title} <span style="font-weight: 300; color: white;">{identity.suffix}</span>
				</h1>
				<div id="status-badge" style={`display: inline-block; background: ${identity.accent}; border: 1px solid ${identity.color}; color: ${identity.color}; padding: 8px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: bold; margin-top: 1.5rem;`}>
					‚óè SYSTEM OPERATIONAL
				</div>
			</header>

      <div id="market-hub" style="display:none; margin-bottom: 3rem; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; border-radius: 1.5rem; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h3 style="margin: 0; font-size: 0.8rem; letter-spacing: 2px; color: #94a3b8;">LIVE MARKET INTELLIGENCE</h3>
          <div style="display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: #4ade80;">
            <span style="height: 6px; width: 6px; background: #4ade80; border-radius: 50%;"></span> LIVE FEED
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
          <div>
            <label style="font-size: 0.7rem; color: #64748b; display: block;">ROOIBOS (AGRI)</label>
            <div id="price-rooibos" style="font-size: 1.8rem; font-weight: 800;">R 38.50</div>
            <div id="levy-rooibos" style="font-size: 0.8rem; color: #f87171;">Levy: 1.5%</div>
          </div>
          <div>
            <label style="font-size: 0.7rem; color: #38bdf8; display: block;">KANNA (IK)</label>
            <div id="price-kanna" style="font-size: 1.8rem; font-weight: 800;">R 455.00</div>
            <div id="levy-kanna" style="font-size: 0.8rem; color: #f87171;">Royalty: 1.0%</div>
          </div>
        </div>

        <div style="border-top: 1px solid #334155; padding-top: 1.5rem;">
          <h4 style="color: #94a3b8; font-size: 0.7rem; margin-bottom: 1rem;">SPLITTER SIMULATOR</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 1.5rem;">
            <input type="number" id="test-weight" value="100" style="background: #0f172a; border: 1px solid #445566; color: white; padding: 8px; border-radius: 6px;">
            <select id="test-tier" style="background: #0f172a; border: 1px solid #445566; color: white; padding: 8px; border-radius: 6px;">
              <option value="raw">Raw (R38)</option>
              <option value="extract">Extract (R8500)</option>
            </select>
          </div>
          <div style="background: #0f172a; padding: 12px; border-radius: 10px; border: 1px solid #334155; display: flex; justify-content: space-between;">
            <span style="font-size: 0.7rem; color: #cbd5e1;">IK ROYALTY:</span>
            <span id="ik-share" style="font-weight: 900; color: #f87171;">R 0.00</span>
          </div>
        </div>
      </div>

			<section style="background: rgba(30, 41, 59, 0.5); border: 1
